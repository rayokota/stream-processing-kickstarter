/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.kafka.rosetta;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Properties;

import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.producer.ProducerConfig;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class Utils {
  private static final Logger log = LoggerFactory.getLogger(Utils.class);

  /**
   * Create a temporary relative directory in the default temporary-file directory with the given
   * prefix.
   *
   * @param prefix The prefix of the temporary directory, if null using "kafka-" as default prefix
   */
  public static File tempDirectory(final String prefix) {
    return tempDirectory(null, prefix);
  }

  /**
   * Create a temporary relative directory in the default temporary-file directory with a
   * prefix of "kafka-"
   *
   * @return the temporary directory just created.
   */
  public static File tempDirectory() {
    return tempDirectory(null);
  }

  /**
   * Create a temporary relative directory in the specified parent directory with the given prefix.
   *
   * @param parent The parent folder path name, if null using the default temporary-file directory
   * @param prefix The prefix of the temporary directory, if null using "kafka-" as default prefix
   */
  public static File tempDirectory(final Path parent, String prefix) {
    final File file;
    prefix = prefix == null ? "kafka-" : prefix;
    try {
      file = parent == null
             ?
             Files.createTempDirectory(prefix).toFile()
             : Files.createTempDirectory(parent, prefix).toFile();
    } catch (final IOException ex) {
      throw new RuntimeException("Failed to create a temp dir", ex);
    }
    file.deleteOnExit();

    Runtime.getRuntime().addShutdownHook(new Thread() {
      @Override
      public void run() {
        try {
          org.apache.kafka.common.utils.Utils.delete(file);
        } catch (IOException e) {
          log.error("Error deleting {}", file.getAbsolutePath(), e);
        }
      }
    });

    return file;
  }

  public static Properties producerConfig(
      final String bootstrapServers,
      final Class keySerializer,
      final Class valueSerializer,
      final Properties additional) {
    final Properties properties = new Properties();
    properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
    properties.put(ProducerConfig.ACKS_CONFIG, "all");
    properties.put(ProducerConfig.RETRIES_CONFIG, 0);
    properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, keySerializer);
    properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, valueSerializer);
    properties.putAll(additional);
    return properties;
  }

  public static Properties consumerConfig(
      final String bootstrapServers,
      final String groupId,
      final Class keyDeserializer,
      final Class valueDeserializer,
      final Properties additional) {

    final Properties consumerConfig = new Properties();
    consumerConfig.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
    consumerConfig.put(ConsumerConfig.GROUP_ID_CONFIG, groupId);
    consumerConfig.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");
    consumerConfig.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, keyDeserializer);
    consumerConfig.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, valueDeserializer);
    consumerConfig.putAll(additional);
    return consumerConfig;
  }
}
